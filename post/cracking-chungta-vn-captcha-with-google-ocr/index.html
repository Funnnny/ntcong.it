<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Breaking Chungta (or VNExpress) captcha with Google&#39;s OCR // Cong Nguyen
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Cong Nguyen">
<meta name="generator" content="Hugo 0.15" />

  <meta property="og:title" content="Breaking Chungta (or VNExpress) captcha with Google&#39;s OCR" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://blog.ntcong.it/post/cracking-chungta-vn-captcha-with-google-ocr/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://blog.ntcong.it/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='http://fonts.googleapis.com/css?family=Roboto:900,500,100,300,700,400' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Cong Nguyen" />

  

  
    <link rel="stylesheet" type="text/css" href="/css/categories.css">
  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/img/avatar.png" class="sidebarphoto">
	

    <h1 class="brand-title">CongNT</h1>
    <h2 class="brand-tagline">Thoughts on Programming and anything Computer</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://blog.ntcong.it">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="https://facebook.com/ntcong.it" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
        
        <a href="http://github.com/ntcong" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="https://plus.google.com/&#43;CongNguyen" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
        
        <a href="http://blog.ntcong.it/posts/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li><a href="#the-captcha:02a117938cf5deaed3c0cd35f6f81d2c">The Captcha</a></li>
<li><a href="#break-it-with-python-and-google-tesseract:02a117938cf5deaed3c0cd35f6f81d2c">Break it with Python and Google Tesseract</a></li>
<li><a href="#wait-is-it-that-simple:02a117938cf5deaed3c0cd35f6f81d2c">Wait, is it that simple?</a></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/post/cracking-chungta-vn-captcha-with-google-ocr/">Breaking Chungta (or VNExpress) captcha with Google&#39;s OCR</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>18</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Dec</span> <span class="post-date-year">2014</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://ntcong.it" target="">Cong Nguyen</a></span>
            		
      <span class="post-author-social post-author-facebook"><a href="http://facebook.com/ntcong.it" target="_blank"><i class="fa fa-facebook"></i></a></span>


      <span class="post-author-social post-author-google-plus"><a href="https://plus.google.com/&#43;CongNguyen" target="_blank"><i class="fa fa-google-plus"></i></a></span>




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-programming" href="http://blog.ntcong.it/categories/programming">programming</a>
				
					<a class="post-category post-category-python" href="http://blog.ntcong.it/categories/python">python</a>
				
				</div>
			

			

			

            

<h1 id="the-captcha:02a117938cf5deaed3c0cd35f6f81d2c">The Captcha</h1>

<p>VNExpress, Chungta.vn, ngoisao.net, they&rsquo;re all using a simple Captcha system to prevent bot voting/submit email. But unfortunately, the system is so easy, we can get around it in five minutes. (So, the voting poll, and all the competition based on voting in VNExpress is useless)</p>

<p>Recently, chungta.vn announced a new beta site with new design. Let&rsquo;s take a look into it to know, if the internal is still the same.</p>

<p>Every site has a contact us form: <a href="http://beta.chungta.vn/contactus">http://beta.chungta.vn/contactus</a>, and let&rsquo;s face it, from the look, this captcha is so easy to crack: <img src="/img/captcha.png" alt="easy" /></p>

<p>So, it seems that they generate an ID from the server side, generate an image and send back that ID and image to the client. The form have an hidden input with the id, and when you press submit, it will just send back the id in &ldquo;captchaID&rdquo; and the input text with &ldquo;txtCode&rdquo;</p>

<p>Problem: you can request the image multiple times.</p>

<p>For most Captcha systems, you can request the image only once. The next time you request the image, it will be replaced by another text. It&rsquo;s an surprisingly easy way to make the life harder for some basic bots (although not that hard).</p>

<p>So you can download the file, store it somewhere, use OCR on it, do some other transformation, and compare the result. If it does not give a acceptable accurate answer, I can just request another (and do it cheap). They are generous enough to give me a link to do it: <a href="http://beta.chungta.vn/captcha/show2">http://beta.chungta.vn/captcha/show2</a></p>

<h1 id="break-it-with-python-and-google-tesseract:02a117938cf5deaed3c0cd35f6f81d2c">Break it with Python and Google Tesseract</h1>

<p><a href="https://code.google.com/p/tesseract-ocr/">Google Tesseract</a> is a very popular OCR engine, with a very accurate result. Combined with Python (because I know it) and PIL, you can do a lot of different thing with it.</p>

<p>Install everything is easy, if you&rsquo;re using Windows, just download tesseract, python and PIL pre-built binary file (aka .exe) and install. If you&rsquo;re using Linux, install it with your package manager:</p>

<div class="highlight" style="background: #002b36"><pre style="line-height: 125%"><span style="color: #cb4b16">$sudo</span> apt-get install tesseract-ocr
<span style="color: #cb4b16">$pip</span> install pytesseract
<span style="color: #cb4b16">$pip</span> install pillow
</pre></div>


<p>So what do we have to do? First we get a captcha with the <a href="http://beta.chungta.vn/captcha/show2">above link</a>, the response is just a json text file. Then we extract the image id, the image above has id:&ldquo;22b3fefb9d316f98489085252bd0d896&rdquo;. Then we download the image by append the id to the url: &ldquo;<a href="http://beta.chungta.vn/captcha/viewimg/id/&quot;">http://beta.chungta.vn/captcha/viewimg/id/&quot;</a>. And last, some magic:</p>

<div class="highlight" style="background: #002b36"><pre style="line-height: 125%"><span style="color: #cb4b16">from</span> <span style="color: #b58900">PIL</span> <span style="color: #cb4b16">import</span> <span style="color: #93a1a1">Image</span>
<span style="color: #cb4b16">import</span> <span style="color: #b58900">pytesseract</span>

<span style="color: #859900">print</span> <span style="color: #93a1a1">pytesseract</span><span style="color: #839496">.</span><span style="color: #93a1a1">image_to_string</span><span style="color: #839496">(</span><span style="color: #93a1a1">Image</span><span style="color: #839496">.</span><span style="color: #93a1a1">open</span><span style="color: #839496">(</span><span style="color: #2aa198">&#39;captcha.png&#39;</span><span style="color: #839496">))</span>
</pre></div>


<p>and the result is: &lsquo;5y47&rsquo;</p>

<h1 id="wait-is-it-that-simple:02a117938cf5deaed3c0cd35f6f81d2c">Wait, is it that simple?</h1>

<p>It is, it showed how ridiculous easy the captcha is. Now we just need to pre-fill the POST data with the id and captcha text, and also the mail content, and what left to do is automated-contact-us-spam-bot.</p>

<p>VNExpress&rsquo; captcha is a little harder, you will need to pre-process the image. How? I will give a hint:</p>

<p>after using Image.open to open the file, you have to:</p>

<ul>
<li>First, convert the image to RGB, then load the image into an array:</li>
</ul>

<p><div class="highlight" style="background: #002b36"><pre style="line-height: 125%"><span style="color: #93a1a1">img</span> <span style="color: #839496">=</span> <span style="color: #93a1a1">Image</span><span style="color: #839496">.</span><span style="color: #93a1a1">open</span><span style="color: #839496">(</span><span style="color: #2aa198">&#39;captcha.png&#39;</span><span style="color: #839496">)</span>
<span style="color: #93a1a1">img</span> <span style="color: #839496">=</span> <span style="color: #93a1a1">img</span><span style="color: #839496">.</span><span style="color: #93a1a1">convert</span><span style="color: #839496">(</span><span style="color: #2aa198">&#39;RGB&#39;</span><span style="color: #839496">)</span>
<span style="color: #93a1a1">data</span> <span style="color: #839496">=</span> <span style="color: #93a1a1">img</span><span style="color: #839496">.</span><span style="color: #93a1a1">load</span><span style="color: #839496">()</span>
</pre></div>
</p>

<ul>
<li>Then, we flip the color for each pixel: set black for color blacker than a little black, and white for others.</li>
</ul>

<p><div class="highlight" style="background: #002b36"><pre style="line-height: 125%"><span style="color: #859900">for</span> <span style="color: #93a1a1">y</span> <span style="color: #859900">in</span> <span style="color: #268bd2">xrange</span><span style="color: #839496">(</span><span style="color: #93a1a1">img</span><span style="color: #839496">.</span><span style="color: #93a1a1">size</span><span style="color: #839496">[</span><span style="color: #2aa198">1</span><span style="color: #839496">]):</span>
    <span style="color: #859900">for</span> <span style="color: #93a1a1">x</span> <span style="color: #859900">in</span> <span style="color: #268bd2">xrange</span><span style="color: #839496">(</span><span style="color: #93a1a1">img</span><span style="color: #839496">.</span><span style="color: #93a1a1">size</span><span style="color: #839496">[</span><span style="color: #2aa198">0</span><span style="color: #839496">]):</span>
        <span style="color: #859900">if</span> <span style="color: #93a1a1">data</span><span style="color: #839496">[</span><span style="color: #93a1a1">x</span><span style="color: #839496">,</span><span style="color: #93a1a1">y</span><span style="color: #839496">]</span> <span style="color: #93a1a1">should</span> <span style="color: #93a1a1">be</span> <span style="color: #93a1a1">black</span><span style="color: #839496">:</span>
            <span style="color: #93a1a1">data</span><span style="color: #839496">[</span><span style="color: #93a1a1">x</span><span style="color: #839496">,</span><span style="color: #93a1a1">y</span><span style="color: #839496">]</span> <span style="color: #839496">=</span> <span style="color: #839496">(</span><span style="color: #2aa198">0</span><span style="color: #839496">,</span> <span style="color: #2aa198">0</span><span style="color: #839496">,</span> <span style="color: #2aa198">0</span><span style="color: #839496">,</span> <span style="color: #2aa198">255</span><span style="color: #839496">)</span>
        <span style="color: #859900">if</span> <span style="color: #93a1a1">data</span><span style="color: #839496">[</span><span style="color: #93a1a1">x</span><span style="color: #839496">,</span><span style="color: #93a1a1">y</span><span style="color: #839496">]</span> <span style="color: #93a1a1">should</span> <span style="color: #93a1a1">be</span> <span style="color: #93a1a1">white</span><span style="color: #839496">:</span>
            <span style="color: #93a1a1">data</span><span style="color: #839496">[</span><span style="color: #93a1a1">x</span><span style="color: #839496">,</span><span style="color: #93a1a1">y</span><span style="color: #839496">]</span> <span style="color: #839496">=</span> <span style="color: #839496">(</span><span style="color: #2aa198">255</span><span style="color: #839496">,</span> <span style="color: #2aa198">255</span><span style="color: #839496">,</span> <span style="color: #2aa198">255</span><span style="color: #839496">,</span> <span style="color: #2aa198">255</span><span style="color: #839496">)</span>
<span style="color: #586e75; font-style: italic"># and save</span>
<span style="color: #93a1a1">img</span><span style="color: #839496">.</span><span style="color: #93a1a1">save</span><span style="color: #839496">(</span><span style="color: #2aa198">&quot;output.png&quot;</span><span style="color: #839496">)</span>
                
</pre></div>
</p>

<p>And then you can just use pytesseract&rsquo;s image_to_string. Sometimes I have to scale the image, and then do a simple anti-alias. But if you implement a good brute-force bot, you can just retry a few times, because the success rate is high.</p>

<p>I&rsquo;ll leave the rest for your imagination. You can send a few thousand contact emails to say hello, or do some voting manipulation for science.</p>

	
			

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-programming" href="http://blog.ntcong.it/tags/programming">programming</a>,
	                
	                <a class="post-tag post-tag-python" href="http://blog.ntcong.it/tags/python">python</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/post/how-vcb-do-otp-or-how-not-to-do-it/">How VCB OTP works and How not to do it</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/post/goodbye-blogspot-hello-hugo/">Goodbye Blogspot, Hello Hugo</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'http:\/\/blog.ntcong.it\/post\/cracking-chungta-vn-captcha-with-google-ocr\/';
    var disqus_title = 'Breaking Chungta (or VNExpress) captcha with Google\x27s OCR';
    var disqus_url = 'http:\/\/blog.ntcong.it\/post\/cracking-chungta-vn-captcha-with-google-ocr\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2015. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
