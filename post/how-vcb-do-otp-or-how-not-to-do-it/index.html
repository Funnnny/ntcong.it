<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>How VCB OTP works and How not to do it</title>

  <meta name="author" content="Cong Nguyen" />
  
  

  <meta name="generator" content="Hugo 0.15" />

  <link rel="alternate" href="http://blog.ntcong.it/index.xml" type="application/rss+xml" title="Cong Nguyen">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://blog.ntcong.it/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://blog.ntcong.it/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://blog.ntcong.it/css/pygment_highlights.css" />
  
  
  <meta property="og:title" content="How VCB OTP works and How not to do it" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/" />
  <meta property="og:image" content="/img/avatar.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://blog.ntcong.it/">Cong Nguyen</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="About" href="/about/">About</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Blog" href="/">Blog</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Cong Nguyen" href="http://blog.ntcong.it/">
              <img class="avatar-img" src="http://blog.ntcong.it//img/avatar.png" alt="Cong Nguyen" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>How VCB OTP works and How not to do it</h1>
      
      
      
      <span class="post-meta">Posted on April 24, 2015</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<h1 id="the-app:facd3c79284655dfd0d0ccd908208d13">The App</h1>

<p>So recently Vietcombank released a Smart OTP app for Android (not so recently anymore since I&rsquo;m holding up the post for a while). They seem to be the first bank to release a app-based OTP, so let&rsquo;s take a look at how they did it.</p>

<p>I&rsquo;m not an Android programmer by any mean, so it takes a while to be able to understand the code and to collect the tools, you may have better results if you are. And also I&rsquo;m a terrible programmer, so just take my words with a grain of salt.</p>

<p>Anyway, the process of decompiler is pretty easy:</p>

<ul>
<li>Use apktool to extract the dex file and Android data files</li>
<li>Use a dex2jar decompiler to convert classes.dex to a jar file</li>
<li>Use a general jar decompiler to convert it back to java files</li>
<li>Open in Eclipse and setup debug environment</li>
</ul>

<p>If you want to decompiler yourself, you might need to do a little homework.</p>

<h1 id="the-problem:facd3c79284655dfd0d0ccd908208d13">The Problem</h1>

<p>First, you have to register your device. In the a/a.java file, they call some webservice from smartotp.vietcombank.com.vn. You will send your number, Mac address and time, and also your confirmation number. Then they will send you back an otp master key. I will trust them to do the right thing and generate that key properly. So let&rsquo;s jump right at the smartotp website.</p>

<p><img src="/img/vcb_web.png" alt="VCB Web" /></p>

<p>Woa, a big red certificate icon: not a good sign. And they list all the web service methods and HOW to call them. <strong>Classic .Net Service1.asmx :)</strong>. You can study further to know how they encrypt and send the request, or you can have fun just by repeatedly sending confirmation and lock your friends from register.</p>

<p>After that I register with the service, and then setup the passcode. Pretty good practice right? You have OTP combined with passcode.
Not that simple, turned out they save app&rsquo;s data in /data/data/vietcombank&hellip;/shared_prefs. The file has some pretty suspicious variables: <strong>pHashPassCode</strong> and <strong>pX_FACTOR</strong>.</p>

<p>Look for the pHashPassCode variable and see how they use it: they merge it with device&rsquo;s Mac address, and md5 the result. Luckily, it&rsquo;s just a 4 numbers passcode, we can brute force it. Or better, set it to &ldquo;1234&rdquo;.</p>

<p>It&rsquo;s pretty sad to see how a big company can&rsquo;t even learn to use the passcode right. What the point of a passcode when people can just replace it with another? Generally we encrypt all the variable or the preference file itself with a key derived from that passcode. Technically someone can still bruteforce if they know the algorithm, but there are methods to prevent it, and even then it&rsquo;s so much better.</p>

<p>And last, let&rsquo;s take a look at the OTP itself. It seems to be a <em>complicated</em> algorithm:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">gg</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">L</span><span class="o">+</span><span class="n">str1</span><span class="o">+</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">D</span><span class="o">+</span><span class="n">str1</span><span class="o">+</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="n">D</span><span class="o">+</span><span class="n">str1</span><span class="o">+</span><span class="n">key</span><span class="p">))</span> 
</code></pre></div>


<ul>
<li>str1: just a floor of time/80 (which means the otp will change each 80s)</li>
<li>D: your phone number</li>
<li>key: the transaction key in VCB&rsquo;s e-banking</li>
<li>L: phone&rsquo;s mac address</li>
<li>y: the secret</li>
</ul>

<p>You might think I forgot the pX_FACTOR above, but no, the pX_FACTOR is y-the-secret here.</p>

<p>And a: it&rsquo;s just a md5 function</p>

<p>So, you don&rsquo;t even need the passcode, just get pX_FACTOR and use it at your PC. Android even have a helpful command: run-as package so you can easily extract the code:</p>

<pre><code>adb shell run-as vietcombank... cat /data/data/vietcombank.../shared_prefs/...
</code></pre>

<p>Convenience, right?</p>

<h1 id="closing:facd3c79284655dfd0d0ccd908208d13">Closing</h1>

<p>I did this nearly two months ago, so something might be missing here. Also I did not know anything better so don&rsquo;t mock me if I&rsquo;m wrong:)</p>

<p>But anyway, here the problem with VCB:</p>

<ul>
<li>Don&rsquo;t use half-assed security implementation. Passcode is nice, but if you decided to implement passcode, do it right. Don&rsquo;t just add passcode for the sake of passcode, let&rsquo;s the user use a better alternative (like the OS&rsquo;s screen lock).</li>
<li>Next time secure your web API, it&rsquo;s not a good thing to expose your web service like that.</li>
<li>I think the secret (or the OTP master key) is a md5 string. Why use a broken algorithm instead of a better implementation? The secret is using just as a string, you can use any hash function for it.</li>
<li>And the OTP: well, it&rsquo;s your choice to do it yourself (or because I&rsquo;m stupid and I don&rsquo;t recognize the standard here :) ). But still, don&rsquo;t use md5. No one charged you for any other methods.</li>
</ul>

<p>I should invest more time into this app, but it&rsquo;s just an OTP generator (and there&rsquo;s standard out there), so why bother :)</p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="http://blog.ntcong.it/post/cracking-chungta-vn-captcha-with-google-ocr/" data-toggle="tooltip" data-placement="top" title="Breaking Chungta (or VNExpress) captcha with Google&#39;s OCR">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="http://blog.ntcong.it/post/xss-with-vnexpress/" data-toggle="tooltip" data-placement="top" title="XSS vulnerabilities on VnExpress">Next Post &rarr;</a>
        </li>
        
      </ul>

      
      <div class="disqus-comments">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'http:\/\/blog.ntcong.it\/post\/how-vcb-do-otp-or-how-not-to-do-it\/';
    var disqus_title = 'How VCB OTP works and How not to do it';
    var disqus_url = 'http:\/\/blog.ntcong.it\/post\/how-vcb-do-otp-or-how-not-to-do-it\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      

    </div>
  </div>
</div>

      

      
      <div class="row disqus-comments">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'http:\/\/blog.ntcong.it\/post\/how-vcb-do-otp-or-how-not-to-do-it\/';
    var disqus_title = 'How VCB OTP works and How not to do it';
    var disqus_url = 'http:\/\/blog.ntcong.it\/post\/how-vcb-do-otp-or-how-not-to-do-it\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
      </div>
      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          <li>
            <a href="https://www.facebook.com/ntcong.it" title="Facebook">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/ntcong" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:ntcong.it@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="https://linkedin.com/in/ntcong" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
	    	  
          <li>
            <a href="https://stackoverflow.com/users/104011/fu4ny" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

    		  <li>
      			<a href="http://blog.ntcong.it/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  Cong Nguyen
    		  &nbsp;&bull;&nbsp;
    		  2016
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="http://blog.ntcong.it/">Cong Nguyen</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="http://blog.ntcong.it/js/jquery-1.11.2.min.js"></script>
<script src="http://blog.ntcong.it/js/bootstrap.min.js"></script>
<script src="http://blog.ntcong.it/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-76172988-1', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>
