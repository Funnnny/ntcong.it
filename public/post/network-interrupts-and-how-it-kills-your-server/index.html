<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Network Interrupts and How It Kills Your Server</title>

  <meta name="author" content="Cong Nguyen" />
  
  

  <meta name="generator" content="Hugo 0.16" />

  <link rel="alternate" href="https://blog.ntcong.it/index.xml" type="application/rss+xml" title="CongNT">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://blog.ntcong.it/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://blog.ntcong.it/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://blog.ntcong.it/css/pygment_highlights.css" />
  
  
  <meta property="og:title" content="Network Interrupts and How It Kills Your Server" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/" />
  <meta property="og:image" content="/img/avatar.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://blog.ntcong.it/">CongNT</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="About" href="/about">About</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Blog" href="/">Blog</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="CongNT" href="https://blog.ntcong.it/">
              <img class="avatar-img" src="https://blog.ntcong.it//img/avatar.png" alt="CongNT" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Network Interrupts and How It Kills Your Server</h1>
      
      
      
      <span class="post-meta">Posted on September 12, 2016</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<p>Two years ago when I was in a SA class, I talked about interrupt storm and how can it kill your server. Some people asked me about the detail technical aspect of how it happens. I think this is a very interesting topic and maybe I should pay my debt.</p>

<h2 id="preface">Preface</h2>

<p>The problem only occur in a very high performance networking setup. In my case it&rsquo;s a server with two 10Gbps card. If your server only have 2 or 4 1Gbps card, there might be some problems, but generally it&rsquo;s because of unoptimized configuration.<br />
I worked on a DDOS-mitigation system, that&rsquo;s why I receive a lot of abnormal traffics, which will put more workload in the system. So if you have a caching server with 2 10Gbps, YMMV.<br />
Linux networking stack is young, many iptables/netfilter path optimization only happened in 2014-2015. Most of the time if you asked people about Linux networking stack, they will just tell you &ldquo;it&rsquo;s slow&rdquo;. In contrast to FreeBSD, which is using for a long time by ISPs, even its toolings are superior to Linux.</p>

<p>Now it&rsquo;s 2016, receiving million of packets per second is not a problem for Linux anymore, but let&rsquo;s first take a look at why send/receive packet in Linux is so slow.</p>

<h2 id="interrupts">Interrupts</h2>

<p>Interrupts are core part of how a processing unit work (either a hardware like CPU, or a software like kernel). Once the CPU receives an interrupt, it will stop the execution, save its context, call the interrupt handle, after that restore its context and then resume the execution. Linux kernel also uses interrupts to handle its processing, called softirq. Nowaday many drivers and core part of the kernel don&rsquo;t use softirq anymore (correct me if I&rsquo;m wrong), the network still uses it.</p>

<p>Everytime you receive a packet, the network card will issue an IRQ (Interrupt Request) to the CPU, the CPU will in turn copy the packet to the memory, and uses netfilter to process it. I will address this after.<br />
Interrupts is very costly, each interrupt costs about 200 to 2000 instructions. So for a famous i5-2500k Intel running at 83G instruction per second, each interrupt is about 12ns.</p>

<h2 id="optimizing-interrupts">Optimizing Interrupts</h2>

<p>Before jumping on some calculation about the challenge of processing a network packet, let&rsquo;s optimize the interrupt handler so it won&rsquo;t die easily.<br />
By default Linux will process all your IRQ in a single CPU core. A few years ago most Linux distro had irqbalance, which will distribute irq across all CPU cores.</p>

<p>But sadly, it&rsquo;s not enough. irqbalance tries to distribute the IRQ across cores, which sometime is not what we wanted: a RX queue receives a lot of packets will scatter over all cores, reducing performance. Nowaday most network cards have multiple RX queue, imagine it&rsquo;s like having multiple network card, the packet from same IP or same target will be sent in a specified queue.<br />
In order to maximize the performance, we need to bind each RX queue to a CPU core, this can be done in a simple script:
<div class="highlight"><pre><code class="language-bash" data-lang="bash">  <span class="o">(</span><span class="nb">let </span><span class="nv">CPU</span><span class="o">=</span>0<span class="p">;</span> <span class="nb">cd</span> /sys/class/net/eth0/device/msi_irqs/<span class="p">;</span>  
    <span class="k">for</span> IRQ in *<span class="p">;</span> <span class="k">do</span>
      <span class="nb">echo</span> <span class="nv">$CPU</span> &gt; /proc/irq/<span class="nv">$IRQ</span>/smp_affinity_list
      <span class="nb">let </span>CPU+<span class="o">=</span>1
    <span class="k">done</span><span class="o">)</span>
</code></pre></div>
</p>

<h2 id="the-problem-with-10gbps">The problem with 10Gbps</h2>

<p>With the rise of 10Gbps network card, the interrupt problem is getting harder to solve. Let&rsquo;s say you receive a large number of DNS respond, around 10G/8/250 = 5M pps. With a i5-2500k@3.3Ghz and 4 cores, you only have 3.3G*4/5M = 2.5k cycle to process each packet, or 1s*4/5M=800ns.</p>

<p>Seems like a lot, but 1 interrupt already costs you 12ns, let&rsquo;s get this very simple and assume each iptables rule only cost 1 interrupt (ignore its processing time), and in a perfect world you can have like 30 iptables rules and lose half of your processing power. And still each cache miss costs around 30-50ns, a lock/unlock costs 16ns, a syscall costs 70ns, leaving you very very little room to process. Your server probably won&rsquo;t have like 50% idle time reserved for networking. Don&rsquo;t let me talk about 2 10Gbps cards.</p>

<p>So, an interrupt storm is when you receive a lot of network packets, overload your system with interrupts. When this happens, your server won&rsquo;t response to keyboard, IO or anything.</p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://blog.ntcong.it/post/for2-google-ctf-write-up/" data-toggle="tooltip" data-placement="top" title="Forensics:For2 Google&#39;s CTF Writeup">&larr; Previous Post</a>
        </li>
        
        
      </ul>

      
      <div class="disqus-comments">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'https:\/\/blog.ntcong.it\/post\/network-interrupts-and-how-it-kills-your-server\/';
    var disqus_title = 'Network Interrupts and How It Kills Your Server';
    var disqus_url = 'https:\/\/blog.ntcong.it\/post\/network-interrupts-and-how-it-kills-your-server\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      

    </div>
  </div>
</div>

      

      
      <div class="row disqus-comments">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'https:\/\/blog.ntcong.it\/post\/network-interrupts-and-how-it-kills-your-server\/';
    var disqus_title = 'Network Interrupts and How It Kills Your Server';
    var disqus_url = 'https:\/\/blog.ntcong.it\/post\/network-interrupts-and-how-it-kills-your-server\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
      </div>
      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          <li>
            <a href="https://www.facebook.com/ntcong.it" title="Facebook">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/ntcong" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:ntcong.it@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="https://linkedin.com/in/ntcong" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
	    	  
          <li>
            <a href="https://stackoverflow.com/users/104011/fu4ny" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

    		  <li>
      			<a href="https://blog.ntcong.it/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
    		  Cong Nguyen
    		  &nbsp;&bull;&nbsp;
    		  2016
    		  
    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="https://blog.ntcong.it/">CongNT</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://blog.ntcong.it/js/jquery-1.11.2.min.js"></script>
<script src="https://blog.ntcong.it/js/bootstrap.min.js"></script>
<script src="https://blog.ntcong.it/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-76172988-1', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>
