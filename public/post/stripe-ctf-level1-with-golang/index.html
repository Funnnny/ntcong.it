<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Stripe-CTF Level 1 with Golang // Cong Nguyen
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Cong Nguyen">
<meta name="generator" content="Hugo 0.14" />

  <meta property="og:title" content="Stripe-CTF Level 1 with Golang" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://blog.ntcong.it/post/stripe-ctf-level1-with-golang/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://blog.ntcong.it/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='http://fonts.googleapis.com/css?family=Roboto:900,500,100,300,700,400' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Cong Nguyen" />

  

  
    <link rel="stylesheet" type="text/css" href="/css/categories.css">
  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    
      <div class="sidebar-avatar-wrapper">
          <img src="/img/avatar.png" alt class="sidebar-avatar">
      </div>
    <h1 class="brand-title">CongNT</h1>
    <h2 class="brand-tagline">Thoughts on Programming and anything Computer</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://blog.ntcong.it">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://blog.ntcong.it/posts/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://plus.google.com/&#43;CongNguyen" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
        
        <a href="https://facebook.com/ntcong.it" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
        
        <a href="http://github.com/ntcong" target="_blank"><i class='fa fa-github'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#basic:08a8d9808c645f9e5c4f35caf364b6d7">Basic</a></li>
<li><a href="#optimize-further:08a8d9808c645f9e5c4f35caf364b6d7">Optimize further</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/post/stripe-ctf-level1-with-golang/">Stripe-CTF Level 1 with Golang</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>7</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Feb</span> <span class="post-date-year">2014</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://ntcong.it" target="">Cong Nguyen</a></span>
            		
      <span class="post-author-social post-author-facebook"><a href="http://facebook.com/ntcong.it" target="_blank"><i class="fa fa-facebook"></i></a></span>


      <span class="post-author-social post-author-google-plus"><a href="https://plus.google.com/&#43;CongNguyen" target="_blank"><i class="fa fa-google-plus"></i></a></span>




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-development" href="http://blog.ntcong.it/categories/development">development</a>
				
					<a class="post-category post-category-go" href="http://blog.ntcong.it/categories/go">go</a>
				
				</div>
			

			

			

            

<p>This year&rsquo;s Stripe-CTF brings some interesting things to the table: Cryptocurrency. I&rsquo;ve already known about cryptocurrency and Bitcoin in general, but it&rsquo;s amazing how Bitcoin relates to Git.</p>

<p>The level is here:&nbsp;<a href="https://stripe-ctf.com/levels/1">https://stripe-ctf.com/levels/1</a></p>

<p>Basically, like Bitcoin, you have to find a block, in this case is a git commit. The commit must have its hash lower than the target difficulty, specified in the file difficulty.txt. You will compete against a bot, and you have to find and submit a block/commit before it does.</p>

<p>As I&rsquo;m learning Golang, I wrote my miner using it, and managed to bring to 1MHash/s. Some people are going higher, specifically those using OpenCL/GPU to mine.</p>

<h3 id="basic:08a8d9808c645f9e5c4f35caf364b6d7">Basic</h3>

<p>The first version of my code is very simple. First it will add myself a Gitcoin to the file &ldquo;LEDGER.txt&rdquo;, get the difficulty, and get the required parameters to build the commit. Those tasks will only do once per block found, so any code will work.</p>

<p>
diff = make([]byte, 0)
diffString := strings.Trim(doExec("cat", "difficulty.txt"), "\n")
for i := 0; i < len(diffString)/2; i++ {
        n, _ := strconv.ParseInt(diffString[i*2:i*2+2], 16, 0)
        diff = append(diff, byte(n))
}
tree = strings.Trim(doExec("git", "write-tree"), "\n")
parent = strings.Trim(doExec("git", "rev-parse", "HEAD"), "\n")
timestamp = strings.Trim(doExec("date", "+%s"), "\n")
</p>

<p>I calculate diff as a byte array because SHA1 library returned the hash as an array, so I don&rsquo;t have to convert SHA1 everytime; doExec is just a function to run the command and return console output as a string. The commit hash can be calculate by SHA1 the string &ldquo;commit [len_commit]\0[commit_string]&ldquo;. The commit string can be built by this code:</p>

<p>
baseCommit = fmt.Sprintf("tree %s\nparent %s\nauthor CTF user <%s@stripe-ctf.com> %s +0000\ncommitter CTF user <%s@stripe-ctf.com> %s +0000\n\nFu[4]ny got a Gitcoin\nnonce 1", tree, parent, username, timestamp, username, timestamp)
</p>

<p>You should already notice the last &ldquo;nonce 1&rdquo; in the commit string, I will replace it with &ldquo;nonce 2&rdquo; and so on until I find a commit with hash lower than difficulty. It&rsquo;s surprisingly simple:</p>

<p>
func getSHA1(n int) [20]byte {
    return sha1.Sum([]byte(baseCommitHash <complete id="goog_259276313">+ </complete>"\n"))
}
func isHashValid(hash [20]byte) bool {
    for i, char := range hash {
    if i >= len(diff) {
    return false
    }
    if char > diff[i] {
    return false
    }
    if char < diff[i] {
    return true
    }
    }
    return false
}
</p>

<p>After finding a coin, I&rsquo;ll write the commit and push it, I was lazy and just pipe everything to command line. It works but maybe a little slow.</p>

<p>
func pushResult(result chan int, done chan bool) {
    var n int
    for {
        n = <-result
        sem <- 1  // Semaphore git command so only one git command at a time
        c1 := exec.Command("echo", getCommit(n, false))
        c2 := exec.Command("git", "hash-object", "-t", "commit", "--stdin", "-w")
        var err error
        c2.Stdin, err = c1.StdoutPipe()
        if err != nil {
            panic(err)
        }
        c2.Stdout = os.Stdout
        _ = c2.Start()
        _ = c1.Run()
        _ = c2.Wait()
        <-sem
        doExec("git", "reset", "--hard", fmt.Sprintf("%x", getCommitSHA(n)))
        res := doExec("git", "push")
        if res != "error" {
            // done <- true
            // do not stop, just wait for a restart
            time.Sleep(10 * time.Second)
        } else {
            log.Println("Error when push, waiting for miner to restart")
            time.Sleep(10 * time.Second)
        }
    }
}
</p>

<p>Then I just loop nonce until I found a coin. I use a result channel to communicate between miner thread and pushResult thread, and a done channel to stop when I find a commit. The bot takes about 10 mins to find a block, with just this version I managed to beat it.</p>

<h3 id="optimize-further:08a8d9808c645f9e5c4f35caf364b6d7">Optimize further</h3>

<p>After finishing the task, I can join a Gitcoin instance with all players in Stripe-CTF. I knew that I have to optimize it because I can push it only to 200kH/s</p>

<p>Fortunately, Go has profiling built-in, so I can easily point out that, most of the time my program was waiting for fmt.Sprintf, because I used it to build the commit message.</p>

<p>So, because the commit is fixed, just the nonce changes, I was able to prebuilt the commit message and the commit hash, just by giving the commit the fixed length and nonce has 16 number. I thought I can create SHA1 with that prebuilt commit and boost the speed of SHA1 function a lot, but I can&rsquo;t, so removing fmt.Sprintf was good for me.</p>

<p>And by competing with more people, I have to monitor new block, and restart my miner with a new blockchain. I built a channel into the miner, and another gorountine to monitor and send stop signal.</p>

<p>Once in a while, the miner will check for stop signal and get out of the loop.</p>

<p>
select {
case msg := <-stop:
    if msg {
        // fmt.Printf("Miner %d stopped! Last i is %d\n", begin, i)
        break jobOuter
    }
default:
}
</p>

<p>The monitor function is pretty straightforward, I have two commit hash, last and current, if last commit has different hash than current commit, I do a git hard reset, and send a stop signal.</p>

<p>
func monitor(stop chan bool) {
    var hash, newHash string
    hash = strings.Trim(doExec("git", "rev-parse", "--short", "origin/master"), "\n")
    for {
        doExec("git", "fetch", "origin")
        newHash = strings.Trim(doExec("git", "rev-parse", "--short", "origin/master"), "\n")
        if hash != newHash {
            doExec("git", "reset", "--hard", "origin/master")
            // log.Println("New block found! Reseting miners!")
            stop <- true
            hash = newHash
            time.Sleep(1 * time.Second)
        }
        time.Sleep(1 * time.Second)
    }
}
</p>

<p>That&rsquo;s almost be all, things I can/should do better:</p>

<ol>
<li>I have to calculate SHA1 again everytime I change nonce. I should calculate a base SHA1, and feed nonce for each loop. I can&rsquo;t find anyway to do this now, so I choose to ignore.</li>
<li>Calling git by command line is bad, maybe use a git library. Sometimes a push does matter, so implement it directly with socket might be good (just the push)</li>
</ol>

<p>I ended the game with 756 point, with several Gitcoins found. It&rsquo;s very hard to find a coin because I only have 1.5MH/s with all my PCs, so I need a lucky moment to get one.</p>

	
			

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-development" href="http://blog.ntcong.it/tags/development">development</a>,
	                
	                <a class="post-tag post-tag-go" href="http://blog.ntcong.it/tags/go">go</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/post/goodbye-blogspot-hello-hugo/">Goodbye Blogspot, Hello Hugo</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/post/bitcoin-protocol-the-basic/">Bitcoin Protocol: The Basic</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'http:\/\/blog.ntcong.it\/post\/stripe-ctf-level1-with-golang\/';
    var disqus_title = 'Stripe-CTF Level 1 with Golang';
    var disqus_url = 'http:\/\/blog.ntcong.it\/post\/stripe-ctf-level1-with-golang\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2015. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>