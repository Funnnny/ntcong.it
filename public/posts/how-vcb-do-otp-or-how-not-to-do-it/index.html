<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    How VCB OTP works and How not to do it // Cong Nguyen
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Cong Nguyen">

  <meta property="og:title" content="How VCB OTP works and How not to do it" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://blog.ntcong.it/posts/how-vcb-do-otp-or-how-not-to-do-it/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://blog.ntcong.it//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='http://fonts.googleapis.com/css?family=Roboto:900,500,100,300,700,400' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Cong Nguyen" />

  

  
    <link rel="stylesheet" type="text/css" href="/css/categories.css">
  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    
      <div class="sidebar-avatar-wrapper">
          <img src="/img/avatar.png" alt class="sidebar-avatar">
      </div>
    <h1 class="brand-title">CongNT</h1>
    <h2 class="brand-tagline">Thoughts on Programming and anything Computer</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://blog.ntcong.it/">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://github.com/Funnnny" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="http://blog.ntcong.it/posts/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://plus.google.com/&#43;CongNguyen" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li><a href="#the-app:facd3c79284655dfd0d0ccd908208d13">The App</a></li>
<li><a href="#the-problem:facd3c79284655dfd0d0ccd908208d13">The Problem</a></li>
<li><a href="#closing:facd3c79284655dfd0d0ccd908208d13">Closing</a></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/posts/how-vcb-do-otp-or-how-not-to-do-it/">How VCB OTP works and How not to do it</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>24</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Apr</span> <span class="post-date-year">2015</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://ntcong.it" target="">Cong Nguyen</a></span>
            		
      <span class="post-author-social post-author-facebook"><a href="http://facebook.com/ntcong.it" target="_blank"><i class="fa fa-facebook"></i></a></span>


      <span class="post-author-social post-author-google-plus"><a href="https://plus.google.com/&#43;CongNguyen" target="_blank"><i class="fa fa-google-plus"></i></a></span>




            	
            

			
			

			

			

            

<h1 id="the-app:facd3c79284655dfd0d0ccd908208d13">The App</h1>

<p>So recently Vietcombank released a Smart OTP app for Android (not so recently anymore since I&rsquo;m holding up the post for a while). They seem to be the first bank to release a app-based OTP, so let&rsquo;s take a look at how they did it.</p>

<p>I&rsquo;m not an Android programmer by any mean, so it takes a while to be able to understand the code and to collect the tools, you may have better results if you are. And also I&rsquo;m a terrible programmer, so just take my words with a grain of salt.</p>

<p>Anyway, the process of decompiler is pretty easy:</p>

<ul>
<li>Use apktool to extract the dex file and Android data files</li>
<li>Use a dex2jar decompiler to convert classes.dex to a jar file</li>
<li>Use a general jar decompiler to convert it back to java files</li>
<li>Open in Eclipse and setup debug environment</li>
</ul>

<p>If you want to decompiler yourself, you might need to do a little homework.</p>

<h1 id="the-problem:facd3c79284655dfd0d0ccd908208d13">The Problem</h1>

<p>First, you have to register your device. In the a/a.java file, they call some webservice from smartotp.vietcombank.com.vn. You will send your number, Mac address and time, and also your confirmation number. Then they will send you back an otp master key. I will trust them to do the right thing and generate that key properly. So let&rsquo;s jump right at the smartotp website.</p>

<p><img src="/img/vcb_web.png" alt="VCB Web" />
</p>

<p>Woa, a big red certificate icon: not a good sign. And they list all the web service methods and HOW to call them. <strong>Classic .Net Service1.asmx :)</strong>. You can study further to know how they encrypt and send the request, or you can have fun just by repeatedly sending confirmation and lock your friends from register.</p>

<p>After that I register with the service, and then setup the passcode. Pretty good practice right? You have OTP combined with passcode.
Not that simple, turned out they save app&rsquo;s data in /data/data/vietcombank&hellip;/shared_prefs. The file has some pretty suspicious variables: <strong>pHashPassCode</strong> and <strong>pX_FACTOR</strong>.</p>

<p>Look for the pHashPassCode variable and see how they use it: they merge it with device&rsquo;s Mac address, and md5 the result. Luckily, it&rsquo;s just a 4 numbers passcode, we can brute force it. Or better, set it to &ldquo;1234&rdquo;.</p>

<p>It&rsquo;s pretty sad to see how a big company can&rsquo;t even learn to use the passcode right. What the point of a passcode when people can just replace it with another? Generally we encrypt all the variable or the preference file itself with a key derived from that passcode. Technically someone can still bruteforce if they know the algorithm, but there are methods to prevent it, and even then it&rsquo;s so much better.</p>

<p>And last, let&rsquo;s take a look at the OTP itself. It seems to be a <em>complicated</em> algorithm:</p>

<p><div class="highlight" style="background: #fdf6e3"><pre style="line-height: 125%"><span style="color: #586e75">gg</span> <span style="color: #657b83">=</span> <span style="color: #586e75">a</span><span style="color: #657b83">(</span><span style="color: #586e75">a</span><span style="color: #657b83">(</span><span style="color: #586e75">y</span><span style="color: #657b83">+</span><span style="color: #586e75">L</span><span style="color: #657b83">+</span><span style="color: #586e75">str1</span><span style="color: #657b83">+</span><span style="color: #586e75">key</span><span style="color: #657b83">)+</span><span style="color: #586e75">a</span><span style="color: #657b83">(</span><span style="color: #586e75">y</span><span style="color: #657b83">+</span><span style="color: #586e75">D</span><span style="color: #657b83">+</span><span style="color: #586e75">str1</span><span style="color: #657b83">+</span><span style="color: #586e75">key</span><span style="color: #657b83">)+</span><span style="color: #586e75">a</span><span style="color: #657b83">(</span><span style="color: #586e75">L</span><span style="color: #657b83">+</span><span style="color: #586e75">D</span><span style="color: #657b83">+</span><span style="color: #586e75">str1</span><span style="color: #657b83">+</span><span style="color: #586e75">key</span><span style="color: #657b83">))</span> 
</pre></div>
</p>

<ul>
<li>str1: just a floor of time/80 (which means the otp will change each 80s)</li>
<li>D: your phone number</li>
<li>key: the transaction key in VCB&rsquo;s e-banking</li>
<li>L: phone&rsquo;s mac address</li>
<li>y: the secret</li>
</ul>

<p>You might think I forgot the pX_FACTOR above, but no, the pX_FACTOR is y-the-secret here.</p>

<p>And a: it&rsquo;s just a md5 function</p>

<p>So, you don&rsquo;t even need the passcode, just get pX_FACTOR and use it at your PC. Android even have a helpful command: run-as package so you can easily extract the code:</p>

<pre><code>adb shell run-as vietcombank... cat /data/data/vietcombank.../shared_prefs/...
</code></pre>

<p>Convenience, right?</p>

<h1 id="closing:facd3c79284655dfd0d0ccd908208d13">Closing</h1>

<p>I did this nearly two months ago, so something might be missing here. Also I did not know anything better so don&rsquo;t mock me if I&rsquo;m wrong:)</p>

<p>But anyway, here the problem with VCB:</p>

<ul>
<li>Don&rsquo;t use half-assed security implementation. Passcode is nice, but if you decided to implement passcode, do it right. Don&rsquo;t just add passcode for the sake of passcode, let&rsquo;s the user use a better alternative (like the OS&rsquo;s screen lock).</li>
<li>Next time secure your web API, it&rsquo;s not a good thing to expose your web service like that.</li>
<li>I think the secret (or the OTP master key) is a md5 string. Why use a broken algorithm instead of a better implementation? The secret is using just as a string, you can use any hash function for it.</li>
<li>And the OTP: well, it&rsquo;s your choice to do it yourself (or because I&rsquo;m stupid and I don&rsquo;t recognize the standard here :) ). But still, don&rsquo;t use md5. No one charged you for any other methods.</li>
</ul>

<p>I should invest more time into this app, but it&rsquo;s just an OTP generator (and there&rsquo;s standard out there), so why bother :)</p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/posts/cracking-chungta-vn-captcha-with-google-ocr/">Breaking Chungta (or VNExpress) captcha with Google&#39;s OCR</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ntcongit';
    var disqus_identifier = 'http:\/\/blog.ntcong.it\/posts\/how-vcb-do-otp-or-how-not-to-do-it\/';
    var disqus_title = 'How VCB OTP works and How not to do it';
    var disqus_url = 'http:\/\/blog.ntcong.it\/posts\/how-vcb-do-otp-or-how-not-to-do-it\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2015. All rights reserved. </p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>