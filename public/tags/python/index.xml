<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>Python on Cong Nguyen </title>
      <generator uri="https://hugo.spf13.com">Hugo</generator>
    <link>http://blog.ntcong.it/tags/python/index.xml/</link>
    <language>en-us</language>
    
    
    <updated>Thu, 18 Dec 2014 10:05:51 ICT</updated>
    
    <item>
      <title>Breaking Chungta (or VNExpress) captcha with Google&#39;s OCR</title>
      <link>http://blog.ntcong.it/posts/cracking-chungta-vn-captcha-with-google-ocr/</link>
      <pubDate>Thu, 18 Dec 2014 10:05:51 ICT</pubDate>
      
      <guid>http://blog.ntcong.it/posts/cracking-chungta-vn-captcha-with-google-ocr/</guid>
      <description>

&lt;h1 id=&#34;toc_0&#34;&gt;The Captcha&lt;/h1&gt;

&lt;p&gt;VNExpress, Chungta.vn, ngoisao.net, they&amp;rsquo;re all using a simple Captcha system to prevent bot voting/submit email. But unfortunately, the system is so easy, we can get around it in five minutes. (So, the voting poll, and all the competition based on voting in VNExpress is useless)&lt;/p&gt;

&lt;p&gt;Recently, chungta.vn announced a new beta site with new design. Let&amp;rsquo;s take a look into it to know, if the internal is still the same.&lt;/p&gt;

&lt;p&gt;Every site has a contact us form: &lt;a href=&#34;http://beta.chungta.vn/contactus&#34;&gt;http://beta.chungta.vn/contactus&lt;/a&gt;, and let&amp;rsquo;s face it, from the look, this captcha is so easy to crack: &lt;img src=&#34;/img/captcha.png&#34; alt=&#34;easy&#34; /&gt;
&lt;/p&gt;

&lt;p&gt;So, it seems that they generate an ID from the server side, generate an image and send back that ID and image to the client. The form have an hidden input with the id, and when you press submit, it will just send back the id in &amp;ldquo;captchaID&amp;rdquo; and the input text with &amp;ldquo;txtCode&amp;rdquo;&lt;/p&gt;

&lt;p&gt;Problem: you can request the image multiple times.&lt;/p&gt;

&lt;p&gt;For most Captcha systems, you can request the image only once. The next time you request the image, it will be replaced by another text. It&amp;rsquo;s an surprisingly easy way to make the life harder for some basic bots (although not that hard).&lt;/p&gt;

&lt;p&gt;So you can download the file, store it somewhere, use OCR on it, do some other transformation, and compare the result. If it does not give a acceptable accurate answer, I can just request another (and do it cheap). They are generous enough to give me a link to do it: &lt;a href=&#34;http://beta.chungta.vn/captcha/show2&#34;&gt;http://beta.chungta.vn/captcha/show2&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;toc_1&#34;&gt;Break it with Python and Google Tesseract&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://code.google.com/p/tesseract-ocr/&#34;&gt;Google Tesseract&lt;/a&gt; is a very popular OCR engine, with a very accurate result. Combined with Python (because I know it) and PIL, you can do a lot of different thing with it.&lt;/p&gt;

&lt;p&gt;Install everything is easy, if you&amp;rsquo;re using Windows, just download tesseract, python and PIL pre-built binary file (aka .exe) and install. If you&amp;rsquo;re using Linux, install it with your package manager:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #fdf6e3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span style=&#34;color: #cb4b16&#34;&gt;$sudo&lt;/span&gt; apt-get install tesseract-ocr
&lt;span style=&#34;color: #cb4b16&#34;&gt;$pip&lt;/span&gt; install pytesseract
&lt;span style=&#34;color: #cb4b16&#34;&gt;$pip&lt;/span&gt; install pillow
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So what do we have to do? First we get a captcha with the &lt;a href=&#34;http://beta.chungta.vn/captcha/show2&#34;&gt;above link&lt;/a&gt;, the response is just a json text file. Then we extract the image id, the image above has id:&amp;ldquo;22b3fefb9d316f98489085252bd0d896&amp;rdquo;. Then we download the image by append the id to the url: &amp;ldquo;&lt;a href=&#34;http://beta.chungta.vn/captcha/viewimg/id/&amp;quot;&#34;&gt;http://beta.chungta.vn/captcha/viewimg/id/&amp;quot;&lt;/a&gt;. And last, some magic:&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #fdf6e3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span style=&#34;color: #cb4b16&#34;&gt;from&lt;/span&gt; &lt;span style=&#34;color: #b58900&#34;&gt;PIL&lt;/span&gt; &lt;span style=&#34;color: #cb4b16&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;Image&lt;/span&gt;
&lt;span style=&#34;color: #cb4b16&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #b58900&#34;&gt;pytesseract&lt;/span&gt;


&lt;span style=&#34;color: #859900&#34;&gt;print&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;pytesseract&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;image_to_string&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;Image&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;open&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;&amp;#39;captcha.png&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;and the result is: &amp;lsquo;5y47&amp;rsquo;&lt;/p&gt;

&lt;h1 id=&#34;toc_2&#34;&gt;Wait, is it that simple?&lt;/h1&gt;

&lt;p&gt;It is, it showed how ridiculous easy the captcha is. Now we just need to pre-fill the POST data with the id and captcha text, and also the mail content, and what left to do is automated-contact-us-spam-bot.&lt;/p&gt;

&lt;p&gt;VNExpress&amp;rsquo; captcha is a little harder, you will need to pre-process the image. How? I will give a hint:&lt;/p&gt;

&lt;p&gt;after using Image.open to open the file, you have to:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;First, convert the image to RGB, then load the image into an array:&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #fdf6e3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;Image&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;open&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;&amp;#39;captcha.png&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;convert&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;&amp;#39;RGB&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #586e75&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;load&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;Then, we flip the color for each pixel: set black for color blacker than a little black, and white for others.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #fdf6e3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span style=&#34;color: #859900&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;y&lt;/span&gt; &lt;span style=&#34;color: #859900&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #268bd2&#34;&gt;xrange&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;]):&lt;/span&gt;
    &lt;span style=&#34;color: #859900&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;x&lt;/span&gt; &lt;span style=&#34;color: #859900&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #268bd2&#34;&gt;xrange&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;size&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;]):&lt;/span&gt;
        &lt;span style=&#34;color: #859900&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;y&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;should&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;be&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;black&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color: #586e75&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;y&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #2aa198&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #2aa198&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #2aa198&#34;&gt;255&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color: #859900&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;y&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;should&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;be&lt;/span&gt; &lt;span style=&#34;color: #586e75&#34;&gt;white&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;:&lt;/span&gt;
            &lt;span style=&#34;color: #586e75&#34;&gt;data&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;x&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;y&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;255&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #2aa198&#34;&gt;255&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #2aa198&#34;&gt;255&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #2aa198&#34;&gt;255&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #93a1a1; font-style: italic&#34;&gt;# and save&lt;/span&gt;
&lt;span style=&#34;color: #586e75&#34;&gt;img&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #586e75&#34;&gt;save&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #2aa198&#34;&gt;&amp;quot;output.png&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #657b83&#34;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And then you can just use pytesseract&amp;rsquo;s image_to_string. Sometimes I have to scale the image, and then do a simple anti-alias. But if you implement a good brute-force bot, you can just retry a few times, because the success rate is high.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ll leave the rest for your imagination. You can send a few thousand contact emails to say hello, or do some voting manipulation for science.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>